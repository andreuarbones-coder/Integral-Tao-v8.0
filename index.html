<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jardín OS v8 Titanium</title>
    
    <!-- === MANIFIESTO PWA === -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"Jardín OS","short_name":"Jardín OS","start_url":".","display":"standalone","background_color":"#1e293b","theme_color":"#0f172a","description":"Gestión Integral de Vivero","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1598/1598196.png","sizes":"192x192","type":"image/png"}]}'>

    <!-- Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Librerías -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Kalam:wght@400;700&display=swap" rel="stylesheet">

    <!-- Configuración Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], handwriting: ['Kalam', 'cursive'] },
                    colors: {
                        theme: {
                            centro: '#064e3b', centroLight: '#34d399',
                            ejemplares: '#312e81', ejemplaresLight: '#818cf8',
                            warning: '#f59e0b', danger: '#ef4444'
                        }
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideIn: { '0%': { transform: 'translateX(-100%)' }, '100%': { transform: 'translateX(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* CSS Core */
        :root { --app-height: 100dvh; --header-height: 64px; }
        body { 
            height: var(--app-height); overflow: hidden; 
            -webkit-tap-highlight-color: transparent; user-select: none;
            background-color: #f1f5f9;
        }
        
        /* Themes */
        body.branch-centro { --primary: #064e3b; --secondary: #ecfdf5; --accent: #10b981; }
        body.branch-ejemplares { --primary: #312e81; --secondary: #eef2ff; --accent: #6366f1; }
        
        /* Scrollbar Hide */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .scroll-area { height: calc(var(--app-height) - var(--header-height)); overflow-y: auto; padding-bottom: 80px; }

        /* Custom UI Components */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        
        /* Chat Bubbles */
        .msg-bubble { max-width: 85%; border-radius: 16px; padding: 12px; margin-bottom: 8px; position: relative; word-wrap: break-word; }
        .msg-me { background-color: var(--secondary); margin-left: auto; color: var(--primary); border-bottom-right-radius: 4px; border: 1px solid rgba(0,0,0,0.05); }
        .msg-other { background-color: white; margin-right: auto; color: #334155; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }

        /* Loader */
        .spinner { border: 3px solid rgba(0,0,0,0.1); border-left-color: var(--accent); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #toast-container { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 100; pointer-events: none; width: 90%; }
        .toast { pointer-events: auto; animation: fade-in-down 0.3s ease-out; background: #1e293b; color: white; padding: 10px 20px; border-radius: 30px; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body id="appBody" class="branch-centro transition-colors duration-500 font-sans text-slate-800">

    <!-- === SIDEBAR NAVIGATION === -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300 opacity-0" onclick="UI.toggleSidebar(false)"></div>
    <aside id="sidebar" class="fixed top-0 left-0 h-full w-72 bg-white z-50 transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col">
        <div class="p-6 text-white" style="background-color: var(--primary);">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                    <i class="fas fa-seedling text-xl"></i>
                </div>
                <div>
                    <h2 class="font-bold text-lg leading-tight">Jardín OS</h2>
                    <p class="text-xs opacity-80 font-mono">v8.0 Titanium</p>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-white/20">
                <p class="text-xs font-bold uppercase opacity-60 mb-1">Sucursal Actual</p>
                <button id="branchToggleBtn" class="flex items-center justify-between w-full bg-black/20 p-2 rounded-lg hover:bg-black/30 transition">
                    <span id="sidebarBranchName" class="font-bold">Centro Tao</span>
                    <i class="fas fa-exchange-alt opacity-70"></i>
                </button>
            </div>
        </div>
        
        <nav class="flex-grow overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="UI.nav('tasks')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent active-nav"><i class="fas fa-tasks w-5"></i> Tareas</button></li>
                <li><button onclick="UI.nav('orders')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-shopping-basket w-5"></i> Pedidos <span id="badgeOrders" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-auto">!</span></button></li>
                <li><button onclick="UI.nav('delivery')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-truck w-5"></i> Repartos <span id="badgeDelivery" class="hidden bg-red-500 text-white text-[10px] px-1.5 py-0.5 rounded-full ml-auto">!</span></button></li>
                <li><button onclick="UI.nav('procedures')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-book w-5"></i> Procesos</button></li>
                <li><button onclick="UI.nav('notes')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-sticky-note w-5"></i> Notas</button></li>
                <li><button onclick="UI.nav('stock')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-cubes w-5"></i> Stock</button></li>
                <li><button onclick="UI.nav('chat')" class="nav-item w-full text-left px-6 py-3 hover:bg-slate-50 flex items-center gap-4 text-slate-600 font-medium border-l-4 border-transparent"><i class="fas fa-walkie-talkie w-5"></i> Radio</button></li>
            </ul>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <button id="wakeLockBtn" class="w-full py-2 px-3 rounded-lg bg-slate-100 text-slate-500 text-xs font-bold flex items-center justify-center gap-2">
                <i class="far fa-lightbulb"></i> <span>Pantalla: Normal</span>
            </button>
            <div class="text-center mt-2 text-[10px] text-slate-400" id="connectionStatus">Conectado</div>
        </div>
    </aside>

    <!-- === MAIN LAYOUT === -->
    <div class="flex flex-col h-full w-full relative">
        
        <!-- HEADER -->
        <header class="flex-none h-[64px] shadow-md flex items-center justify-between px-4 z-20 text-white transition-colors duration-500" style="background-color: var(--primary);">
            <div class="flex items-center gap-3">
                <button onclick="UI.toggleSidebar(true)" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 active:scale-95 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h1 id="pageTitle" class="font-bold text-lg leading-none">Mis Tareas</h1>
                    <span id="currentDate" class="text-xs opacity-80 capitalize">Cargando...</span>
                </div>
            </div>
            <div class="flex items-center gap-2">
                 <!-- Status icons/indicators can go here -->
                 <div id="loadingIndicator" class="hidden spinner border-white/30 border-l-white"></div>
            </div>
        </header>

        <!-- CONTENT AREA -->
        <main id="mainContainer" class="flex-grow relative bg-slate-100 overflow-hidden">
            
            <!-- VIEW: TASKS -->
            <div id="view-tasks" class="view-section scroll-area p-4">
                <div id="taskList" class="space-y-3 pb-24">
                    <!-- Skeleton -->
                    <div class="animate-pulse bg-white h-24 rounded-xl"></div>
                </div>
            </div>

            <!-- VIEW: ORDERS (PEDIDOS) -->
            <div id="view-orders" class="view-section scroll-area hidden p-4">
                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded-xl mb-4 text-sm flex items-center justify-center gap-2 text-center">
                    <i class="fas fa-info-circle"></i> Canal compartido de pedidos de stock
                </div>
                <div id="ordersList" class="space-y-3 pb-24"></div>
            </div>

            <!-- VIEW: DELIVERY -->
            <div id="view-delivery" class="view-section scroll-area hidden p-4">
                <div id="deliveryList" class="space-y-4 pb-24"></div>
            </div>

            <!-- VIEW: NOTES -->
            <div id="view-notes" class="view-section scroll-area hidden p-4">
                <div id="notesList" class="grid gap-4 pb-24"></div>
            </div>

            <!-- VIEW: PROCEDURES -->
            <div id="view-procedures" class="view-section scroll-area hidden p-4">
                <div id="proceduresList" class="space-y-4 pb-24"></div>
            </div>

            <!-- VIEW: STOCK -->
            <div id="view-stock" class="view-section scroll-area hidden flex items-center justify-center flex-col opacity-50">
                <i class="fas fa-tools text-6xl mb-4 text-slate-300"></i>
                <p>Módulo de Stock en construcción</p>
            </div>

            <!-- VIEW: CHAT -->
            <div id="view-chat" class="view-section hidden h-full flex flex-col">
                <div id="chatList" class="flex-grow overflow-y-auto p-4 space-y-2 pb-4"></div>
                <div class="p-3 bg-white border-t border-slate-200 flex items-center gap-2 pb-[max(12px,env(safe-area-inset-bottom))]">
                     <button onclick="document.getElementById('chatImageInput').click()" class="p-3 text-slate-400 hover:text-emerald-600"><i class="fas fa-camera text-xl"></i></button>
                     <input type="file" id="chatImageInput" accept="image/*" class="hidden" onchange="window.handleChatImage(this)">
                     <div class="flex-grow bg-slate-100 rounded-full px-4 py-2">
                        <input type="text" id="chatTextInput" class="w-full bg-transparent outline-none" placeholder="Mensaje...">
                     </div>
                     <button id="sendChatBtn" class="text-slate-500 p-3"><i class="fas fa-paper-plane text-lg"></i></button>
                     <button id="micBtn" class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center shadow-lg active:scale-95"><i class="fas fa-microphone"></i></button>
                </div>
            </div>

        </main>

        <!-- FAB (Floating Action Button) -->
        <div id="fabContainer" class="fixed bottom-6 right-6 z-30 transition-transform duration-300 pb-[env(safe-area-inset-bottom)]">
            <button id="mainFab" class="w-14 h-14 rounded-full text-white shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-transform hover:shadow-2xl" style="background-color: var(--accent);">
                <i class="fas fa-plus"></i>
            </button>
        </div>

    </div>

    <!-- === MODALS === -->
    <div id="modalOverlay" class="hidden fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        
        <!-- MODAL: TASK (CREATE/EDIT) -->
        <div id="modal-tasks" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-slate-800" id="taskModalTitle">Nueva Tarea</h2>
                    <button class="modal-close text-slate-400"><i class="fas fa-times"></i></button>
                </div>
                <input type="hidden" id="taskId"> <!-- For edits -->
                <div class="space-y-4">
                    <input type="text" id="taskInput" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none focus:border-emerald-500 font-medium" placeholder="Descripción de la tarea">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="taskAssignee" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Responsable">
                        <select id="taskPriority" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm font-bold text-slate-600">
                            <option value="low">Baja</option>
                            <option value="medium">Media</option>
                            <option value="high">Alta</option>
                            <option value="critical">URGENTE</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase ml-1">Repetición (Ciclo)</label>
                        <div class="flex items-center gap-2 mt-1 bg-slate-50 p-2 rounded-xl border border-slate-200">
                            <div class="bg-indigo-100 text-indigo-600 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-sync-alt"></i></div>
                            <select id="taskCycle" class="bg-transparent w-full outline-none text-sm font-medium text-slate-700">
                                <option value="none">No cíclica (Una vez)</option>
                                <option value="daily">Todos los días</option>
                                <option value="weekly">Semanal (7 días)</option>
                                <option value="monthly">Mensual</option>
                                <option value="quarterly">Cada 3 meses</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button id="saveTaskBtn" class="w-full mt-6 py-3.5 text-white rounded-xl shadow-lg font-bold text-lg active:scale-95 transition-transform" style="background-color: var(--primary);">Guardar Tarea</button>
            </div>
        </div>

        <!-- MODAL: ORDER (PEDIDOS) -->
        <div id="modal-orders" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><i class="fas fa-shopping-basket text-blue-600"></i> Nuevo Pedido</h2>
                <div class="space-y-3">
                    <input type="text" id="orderItem" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold" placeholder="¿Qué necesitamos?">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="orderAmount" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="Cantidad">
                        <input type="text" id="orderRequester" class="p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none" placeholder="¿Quién pide?">
                    </div>
                    <textarea id="orderNotes" rows="2" class="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Detalles adicionales (marca, modelo, etc)"></textarea>
                </div>
                <button id="saveOrderBtn" class="w-full mt-6 py-3.5 bg-blue-600 text-white rounded-xl shadow-lg font-bold active:scale-95">Solicitar</button>
            </div>
        </div>

        <!-- MODAL: DELIVERY -->
        <div id="modal-delivery" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl overflow-hidden hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Nuevo Reparto</h2>
                <div class="space-y-3">
                    <input type="text" id="delClient" class="w-full p-3 bg-slate-50 rounded-xl outline-none border border-slate-200" placeholder="Cliente">
                    <input type="tel" id="delPhone" class="w-full p-3 bg-slate-50 rounded-xl outline-none border border-slate-200" placeholder="Teléfono">
                    <textarea id="delItems" rows="3" class="w-full p-3 bg-slate-50 rounded-xl outline-none border border-slate-200" placeholder="Items a entregar..."></textarea>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" id="delWhen" class="p-3 bg-slate-50 rounded-xl text-sm border border-slate-200" placeholder="¿Cuándo?">
                        <input type="text" id="delWhere" class="p-3 bg-slate-50 rounded-xl text-sm border border-slate-200" placeholder="Dirección">
                    </div>
                </div>
                <button id="saveDelBtn" class="w-full mt-6 py-3.5 bg-indigo-600 text-white rounded-xl shadow-lg font-bold active:scale-95">Agendar Reparto</button>
            </div>
        </div>

         <!-- MODAL: NOTES -->
        <div id="modal-notes" class="bg-yellow-50 w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl border-t-4 border-yellow-400 hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-yellow-800 mb-4">Nueva Nota</h2>
                <select id="noteType" class="w-full p-2 mb-4 bg-yellow-100 border-none rounded text-yellow-900 font-bold"><option value="normal">General</option><option value="billing">Cobranza $$</option></select>
                <textarea id="noteContent" rows="6" class="w-full bg-transparent text-xl font-handwriting placeholder-yellow-800/30 outline-none" placeholder="Escribe aquí..."></textarea>
                <div class="flex gap-2 mt-4">
                    <button class="modal-close flex-1 py-3 text-yellow-700 font-bold">Cancelar</button>
                    <button id="saveNoteBtn" class="flex-1 py-3 bg-yellow-400 text-yellow-900 rounded-xl font-bold shadow-sm">Pegar Nota</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PROCEDURES -->
         <div id="modal-procedures" class="bg-white w-full sm:max-w-md sm:rounded-2xl rounded-t-2xl shadow-2xl hidden transform transition-transform duration-300 translate-y-full sm:translate-y-0">
            <div class="p-5">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Nuevo Proceso</h2>
                <input type="text" id="procTitle" class="w-full p-3 mb-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold" placeholder="Título del Protocolo">
                <textarea id="procSteps" rows="5" class="w-full p-3 mb-4 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="- Paso 1&#10;- Paso 2..."></textarea>
                <div class="flex justify-between mb-6 px-2">
                    <label><input type="radio" name="procColor" value="blue" checked class="accent-blue-500 w-5 h-5"></label>
                    <label><input type="radio" name="procColor" value="green" class="accent-emerald-500 w-5 h-5"></label>
                    <label><input type="radio" name="procColor" value="red" class="accent-red-500 w-5 h-5"></label>
                    <label><input type="radio" name="procColor" value="purple" class="accent-purple-500 w-5 h-5"></label>
                </div>
                <button id="saveProcBtn" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Guardar Protocolo</button>
            </div>
        </div>

    </div>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // CONFIG
        const manualConfig = { apiKey: "", authDomain: "app-jardin-v4.firebaseapp.com", projectId: "app-jardin-v4", storageBucket: "app-jardin-v4.firebasestorage.app", messagingSenderId: "413324369604", appId: "1:413324369604:web:f78e3f459725dd824e3391" };
        let firebaseConfig = null;
        try { if (typeof __firebase_config !== 'undefined' && __firebase_config) firebaseConfig = JSON.parse(__firebase_config); else if (typeof manualConfig !== 'undefined') firebaseConfig = manualConfig; } catch(e) {}
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'jardin-os-v8';

        // STATE
        const State = {
            user: null,
            branch: localStorage.getItem('tao_branch') || 'centro',
            view: 'tasks',
            listeners: {}
        };

        // UI MANAGER
        const UI = {
            init() {
                this.setBranch(State.branch);
                this.nav('tasks');
                document.getElementById('currentDate').innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
                
                // Event Listeners
                document.getElementById('branchToggleBtn').onclick = () => this.toggleBranch();
                document.querySelectorAll('.modal-close').forEach(b => b.onclick = () => this.closeModal());
                document.getElementById('modalOverlay').onclick = (e) => { if(e.target === document.getElementById('modalOverlay')) this.closeModal(); };
                document.getElementById('mainFab').onclick = () => this.handleFab();
            },

            setBranch(branch) {
                State.branch = branch;
                localStorage.setItem('tao_branch', branch);
                const body = document.getElementById('appBody');
                const label = document.getElementById('sidebarBranchName');
                
                if (branch === 'centro') {
                    body.className = 'branch-centro transition-colors duration-500 font-sans text-slate-800';
                    label.innerText = 'Centro Tao';
                } else {
                    body.className = 'branch-ejemplares transition-colors duration-500 font-sans text-slate-800';
                    label.innerText = 'Ejemplares Tao';
                }
                
                if(State.user) Data.resubscribe();
                this.toast(`Cambiado a ${label.innerText}`);
            },

            toggleBranch() {
                this.setBranch(State.branch === 'centro' ? 'ejemplares' : 'centro');
            },

            toggleSidebar(show) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (show) {
                    overlay.classList.remove('hidden');
                    // Force reflow
                    void overlay.offsetWidth; 
                    overlay.classList.remove('opacity-0');
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    overlay.classList.add('opacity-0');
                    sidebar.classList.add('-translate-x-full');
                    setTimeout(() => overlay.classList.add('hidden'), 300);
                }
            },

            nav(view) {
                State.view = view;
                this.toggleSidebar(false);
                
                // Update Sidebar Active State
                document.querySelectorAll('.nav-item').forEach(el => {
                    el.classList.remove('active-nav', 'bg-slate-50', 'border-slate-500');
                    if (el.getAttribute('onclick').includes(view)) {
                        el.classList.add('bg-slate-50', 'border-slate-500');
                        el.querySelector('i').style.color = 'var(--primary)';
                    } else {
                        el.querySelector('i').style.color = '';
                    }
                });

                // Switch Views
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');

                // Update Header
                const titles = { tasks: 'Tareas', orders: 'Pedidos', delivery: 'Repartos', notes: 'Notas', procedures: 'Procesos', stock: 'Inventario', chat: 'Radio Frecuencia' };
                document.getElementById('pageTitle').innerText = titles[view];
                
                // Chat Scroll
                if(view === 'chat') this.scrollToBottom('chatList');
            },

            openModal(id, data = null) {
                const modal = document.getElementById(id);
                const overlay = document.getElementById('modalOverlay');
                overlay.classList.remove('hidden');
                modal.classList.remove('hidden');
                
                // Animation
                requestAnimationFrame(() => {
                    modal.classList.remove('translate-y-full');
                    if(window.innerWidth >= 640) modal.classList.remove('sm:translate-y-full');
                });

                // Logic specific for edits
                if (id === 'modal-tasks') {
                    if (data) {
                        document.getElementById('taskModalTitle').innerText = "Editar Tarea";
                        document.getElementById('taskId').value = data.id;
                        document.getElementById('taskInput').value = data.text;
                        document.getElementById('taskAssignee').value = data.assignee || '';
                        document.getElementById('taskPriority').value = data.priority || 'medium';
                        document.getElementById('taskCycle').value = data.cycle || 'none';
                    } else {
                        document.getElementById('taskModalTitle').innerText = "Nueva Tarea";
                        document.getElementById('taskId').value = '';
                        document.getElementById('taskInput').value = '';
                        document.getElementById('taskCycle').value = 'none';
                    }
                }
            },

            closeModal() {
                const overlay = document.getElementById('modalOverlay');
                const openModals = document.querySelectorAll('#modalOverlay > div:not(.hidden)');
                
                openModals.forEach(m => {
                    m.classList.add('translate-y-full');
                    if(window.innerWidth >= 640) m.classList.add('sm:translate-y-full');
                });
                
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    openModals.forEach(m => m.classList.add('hidden'));
                }, 300);
            },

            handleFab() {
                const map = { tasks: 'modal-tasks', orders: 'modal-orders', delivery: 'modal-delivery', notes: 'modal-notes', procedures: 'modal-procedures' };
                if (map[State.view]) this.openModal(map[State.view]);
            },

            toast(msg, type='info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = { info: 'text-blue-400', success: 'text-emerald-400', error: 'text-red-400' };
                const icon = type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
                
                el.className = 'toast';
                el.innerHTML = `<i class="fas ${icon} ${colors[type]}"></i> <span>${msg}</span>`;
                container.appendChild(el);
                
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-10px)';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },
            
            scrollToBottom(id) {
                const el = document.getElementById(id);
                if(el) el.scrollTop = el.scrollHeight;
            },

            renderTasks(tasks) {
                const list = document.getElementById('taskList');
                list.innerHTML = '';
                if(tasks.length === 0) { list.innerHTML = this.emptyState('relax', 'Todo listo por hoy'); return; }

                const prioColor = { critical: 'border-l-red-500', high: 'border-l-orange-500', medium: 'border-l-blue-500', low: 'border-l-emerald-500' };
                const prioText = { critical: 'URGENTE', high: 'ALTA', medium: 'MEDIA', low: 'BAJA' };

                tasks.forEach(t => {
                    const isDone = t.status === 'done';
                    const isPartial = t.status === 'partial';
                    const cycleLabel = t.cycle && t.cycle !== 'none' ? `<span class="bg-indigo-100 text-indigo-700 text-[10px] px-2 py-0.5 rounded-full font-bold flex items-center gap-1"><i class="fas fa-sync-alt text-[8px]"></i> ${this.getCycleName(t.cycle)}</span>` : '';
                    
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl p-4 shadow-sm border-l-4 ${prioColor[t.priority] || 'border-l-slate-300'} flex gap-3 transition-all ${isDone ? 'opacity-50' : ''}`;
                    
                    let statusBtn = '';
                    if (isDone) {
                         statusBtn = `<button onclick="window.updateTaskStatus('${t.id}', 'pending')" class="w-8 h-8 rounded-full bg-emerald-500 text-white flex items-center justify-center shadow-md"><i class="fas fa-check"></i></button>`;
                    } else if (isPartial) {
                         statusBtn = `<button onclick="window.updateTaskStatus('${t.id}', 'done')" class="w-8 h-8 rounded-full bg-amber-400 text-white flex items-center justify-center shadow-md animate-pulse"><i class="fas fa-hourglass-half"></i></button>`;
                    } else {
                         statusBtn = `<button onclick="window.updateTaskStatus('${t.id}', 'done')" class="w-8 h-8 rounded-full border-2 border-slate-300 text-transparent hover:border-emerald-400 transition-colors"></button>`;
                    }

                    div.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">${prioText[t.priority] || 'NORMAL'}</span>
                                ${cycleLabel}
                            </div>
                            <h3 class="text-slate-800 font-medium leading-tight ${isDone ? 'line-through text-slate-400' : ''}">${t.text}</h3>
                            <div class="flex items-center justify-between mt-2">
                                <span class="text-xs text-slate-400 flex items-center gap-1"><i class="fas fa-user-circle"></i> ${t.assignee || 'Sin asignar'}</span>
                                <button onclick='window.editTask(${JSON.stringify(t)})' class="text-slate-300 hover:text-slate-500 px-2"><i class="fas fa-ellipsis-h"></i></button>
                            </div>
                        </div>
                        <div class="flex flex-col items-center gap-2 pt-1 border-l border-slate-100 pl-3">
                            ${statusBtn}
                            ${!isDone && !isPartial ? `<button onclick="window.updateTaskStatus('${t.id}', 'partial')" class="text-xs text-amber-400 font-bold">1/2</button>` : ''}
                            ${isDone && !t.cycle ? `<button onclick="window.delTask('${t.id}')" class="text-red-300 hover:text-red-500 mt-auto"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            getCycleName(c) {
                const map = { daily: 'Diario', weekly: 'Semanal', monthly: 'Mensual', quarterly: 'Trimestral' };
                return map[c] || c;
            },

            renderOrders(orders) {
                const list = document.getElementById('ordersList');
                list.innerHTML = '';
                const pending = orders.filter(o => o.status !== 'received').length;
                const badge = document.getElementById('badgeOrders');
                badge.classList.toggle('hidden', pending === 0);

                if(orders.length === 0) { list.innerHTML = this.emptyState('shopping-basket', 'Sin pedidos pendientes'); return; }

                orders.forEach(o => {
                    const isReceived = o.status === 'received';
                    const isOrdered = o.status === 'ordered';
                    
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl p-4 shadow-sm border border-slate-200 relative ${isReceived ? 'opacity-60 bg-slate-50' : ''}`;
                    
                    let statusBadge = '';
                    if(isReceived) statusBadge = '<span class="bg-emerald-100 text-emerald-700 text-xs px-2 py-1 rounded font-bold">RECIBIDO</span>';
                    else if(isOrdered) statusBadge = '<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">COMPRADO</span>';
                    else statusBadge = '<span class="bg-slate-100 text-slate-500 text-xs px-2 py-1 rounded font-bold">PENDIENTE</span>';

                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-slate-800">${o.item} <span class="text-sm font-normal text-slate-500">x${o.amount}</span></h3>
                            ${statusBadge}
                        </div>
                        ${o.notes ? `<p class="text-sm text-slate-600 italic bg-slate-50 p-2 rounded mb-2">${o.notes}</p>` : ''}
                        <div class="flex justify-between items-center text-xs text-slate-400 mt-2">
                            <span>Solicitado por: <strong>${o.requester}</strong> (${o.branch})</span>
                            <div class="flex gap-2">
                                ${!isReceived ? `<button onclick="window.advanceOrder('${o.id}', '${o.status}')" class="text-blue-600 font-bold hover:underline">AVANZAR</button>` : ''}
                                <button onclick="window.delShared('orders', '${o.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            renderDeliveries(items) {
                const list = document.getElementById('deliveryList');
                list.innerHTML = '';
                const pending = items.filter(i => i.status === 'pending').length;
                document.getElementById('badgeDelivery').classList.toggle('hidden', pending === 0);
                
                if(items.length === 0) { list.innerHTML = this.emptyState('truck', 'Nada para repartir'); return; }

                items.forEach(d => {
                    const isDone = d.status === 'delivered';
                    const isIncomplete = d.status === 'incomplete';
                    const div = document.createElement('div');
                    div.className = `bg-white rounded-xl shadow-sm border overflow-hidden ${isDone ? 'opacity-50 border-slate-200' : isIncomplete ? 'border-orange-200 bg-orange-50' : 'border-slate-200'}`;
                    
                    div.innerHTML = `
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-slate-900">${d.client}</h3>
                                    <a href="tel:${d.phone}" class="text-emerald-600 text-sm font-bold flex items-center gap-1"><i class="fas fa-phone"></i> ${d.phone}</a>
                                </div>
                                <div class="text-right">
                                    <span class="block text-xs font-bold text-slate-500 uppercase tracking-wide">${d.status === 'pending' ? 'Pendiente' : d.status === 'delivered' ? 'Entregado' : 'Incompleto'}</span>
                                    <span class="text-[10px] text-slate-400">${new Date(d.createdAt.seconds*1000).toLocaleDateString()}</span>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 text-sm text-slate-700 italic mb-3">
                                ${d.items}
                            </div>
                            <div class="flex gap-4 text-xs text-slate-500 font-medium">
                                <span class="flex items-center gap-1"><i class="far fa-clock"></i> ${d.when}</span>
                                <span class="flex items-center gap-1 text-blue-500"><i class="fas fa-map-marker-alt"></i> ${d.where}</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 border-t border-slate-100 p-2 flex justify-between items-center">
                            <button onclick="window.delShared('deliveries', '${d.id}')" class="text-xs text-red-400 px-2">ELIMINAR</button>
                            <div class="flex gap-2">
                                <button onclick="window.updateDelStatus('${d.id}', 'incomplete')" class="px-3 py-1 bg-orange-100 text-orange-600 rounded text-xs font-bold">Incompleto</button>
                                <button onclick="window.updateDelStatus('${d.id}', 'delivered')" class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded text-xs font-bold">Entregado</button>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            renderNotes(notes) {
                const list = document.getElementById('notesList');
                list.innerHTML = '';
                notes.forEach(n => {
                    const isMoney = n.type === 'billing';
                    const div = document.createElement('div');
                    div.className = `p-4 rounded-xl shadow-sm border relative ${isMoney ? 'bg-amber-50 border-amber-200' : 'bg-yellow-50 border-yellow-200'}`;
                    div.innerHTML = `
                        ${isMoney ? '<span class="absolute -top-2 left-4 bg-amber-500 text-white text-[10px] px-2 rounded">COBRAR</span>' : ''}
                        <p class="whitespace-pre-wrap font-handwriting text-lg text-slate-800 leading-relaxed">${n.content}</p>
                        <button onclick="window.delItem('notes', '${n.id}')" class="absolute top-2 right-2 text-slate-300 hover:text-red-500"><i class="fas fa-times"></i></button>
                    `;
                    list.appendChild(div);
                });
            },
            
            renderProcedures(procs) {
                const list = document.getElementById('proceduresList');
                list.innerHTML = '';
                const colors = { blue: 'bg-blue-50 border-blue-200 text-blue-900', green: 'bg-emerald-50 border-emerald-200 text-emerald-900', red: 'bg-red-50 border-red-200 text-red-900', purple: 'bg-purple-50 border-purple-200 text-purple-900' };
                
                procs.forEach(p => {
                    const style = colors[p.color] || colors.blue;
                    const steps = p.steps.split('\n').map(s => `<li class="flex items-start gap-2 mb-1"><span class="mt-1.5 w-1.5 h-1.5 rounded-full bg-current opacity-50 flex-shrink-0"></span><span>${s.replace(/^- /, '')}</span></li>`).join('');
                    const div = document.createElement('div');
                    div.className = `rounded-xl shadow-sm border p-5 relative ${style}`;
                    div.innerHTML = `
                        <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-clipboard-check opacity-50"></i> ${p.title}</h3>
                        <ul class="text-sm opacity-90 leading-relaxed">${steps}</ul>
                        <button onclick="window.delShared('procedures', '${p.id}')" class="absolute top-4 right-4 opacity-30 hover:opacity-100 hover:text-red-600 transition"><i class="fas fa-trash"></i></button>
                    `;
                    list.appendChild(div);
                });
            },

            renderChat(msgs) {
                const list = document.getElementById('chatList');
                list.innerHTML = '';
                msgs.forEach(m => {
                    const isMe = m.sender === State.user.uid;
                    const div = document.createElement('div');
                    div.className = `msg-bubble ${isMe ? 'msg-me' : 'msg-other'}`;
                    
                    let content = '';
                    if(m.type === 'text') content = `<p>${m.text}</p>`;
                    if(m.type === 'image') content = `<img src="${m.url}" class="rounded-lg max-h-48 w-full object-cover" onclick="window.open(this.src)">`;
                    
                    const time = m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                    
                    div.innerHTML = `${content}<div class="text-[10px] text-right mt-1 opacity-50">${time}</div>`;
                    list.appendChild(div);
                });
                // Only scroll if near bottom or first load (simplified here to always scroll for demo)
                // this.scrollToBottom('chatList'); 
            },

            emptyState(icon, text) {
                return `<div class="flex flex-col items-center justify-center py-10 opacity-40 gap-3"><i class="fas fa-${icon} text-4xl"></i><p>${text}</p></div>`;
            }
        };
        window.UI = UI; // Expose to global scope for HTML event handlers

        // DATA MANAGER
        const Data = {
            // FIX: STRICT PATHS FOR RULES
            getCol(name) { return collection(db, 'artifacts', APP_ID, 'public', 'data', name); },

            resubscribe() {
                // Unsubscribe existing
                Object.values(State.listeners).forEach(u => u && u());

                // Tasks - CLIENT SIDE FILTERING TO AVOID INDEX ERRORS
                State.listeners.tasks = onSnapshot(this.getCol('tasks'), (snap) => {
                    const tasks = []; 
                    snap.forEach(d => {
                        const data = d.data();
                        if (data.branch === State.branch) tasks.push({id: d.id, ...data});
                    });
                    // Client sort
                    const pVal = {critical:0, high:1, medium:2, low:3};
                    tasks.sort((a,b) => {
                        if(pVal[a.priority] !== pVal[b.priority]) return pVal[a.priority] - pVal[b.priority];
                        return (b.createdAt?.seconds||0) - (a.createdAt?.seconds||0);
                    });
                    UI.renderTasks(tasks);
                });

                // Notes
                State.listeners.notes = onSnapshot(this.getCol('notes'), (snap) => {
                    const items = []; 
                    snap.forEach(d => {
                        const data = d.data();
                        if (data.branch === State.branch) items.push({id: d.id, ...data});
                    });
                    UI.renderNotes(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });

                // Chat
                State.listeners.chat = onSnapshot(this.getCol('chat'), (snap) => {
                    const items = []; 
                    snap.forEach(d => {
                        const data = d.data();
                        if (data.branch === State.branch) items.push({id: d.id, ...data});
                    });
                    items.sort((a,b) => (a.createdAt?.seconds||0)-(b.createdAt?.seconds||0));
                    UI.renderChat(items);
                    UI.scrollToBottom('chatList');
                });

                // Shared: Deliveries
                State.listeners.delivery = onSnapshot(this.getCol('deliveries'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderDeliveries(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });

                // Shared: Procedures
                State.listeners.procedures = onSnapshot(this.getCol('procedures'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderProcedures(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });

                // Shared: Orders
                State.listeners.orders = onSnapshot(this.getCol('orders'), (snap) => {
                    const items = []; snap.forEach(d => items.push({id: d.id, ...d.data()}));
                    UI.renderOrders(items.sort((a,b) => (b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
                });
            }
        };

        // GLOBAL ACTIONS
        window.updateTaskStatus = async (id, status) => {
            try { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id), { status }); } catch(e) { UI.toast('Error', 'error'); }
        };
        window.editTask = (task) => { UI.openModal('modal-tasks', task); };
        window.delTask = async (id) => { if(confirm('¿Eliminar?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id)); };
        window.delItem = async (col, id) => { if(confirm('¿Eliminar?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id)); };
        window.delShared = async (col, id) => { if(confirm('¿Eliminar Global?')) await deleteDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', col, id)); };
        
        window.updateDelStatus = async (id, status) => {
             await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'deliveries', id), { status });
        };
        window.advanceOrder = async (id, current) => {
            const next = current === 'pending' ? 'ordered' : 'received';
            await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'orders', id), { status: next });
        };

        window.handleChatImage = async (input) => {
            const file = input.files[0];
            if(!file) return;
            UI.toast('Subiendo imagen...');
            try {
                const storageRef = ref(storage, `chat/${Date.now()}_${file.name}`);
                const snap = await uploadBytes(storageRef, file);
                const url = await getDownloadURL(snap.ref);
                await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), { 
                    type: 'image', url, sender: State.user.uid, 
                    branch: State.branch,
                    createdAt: serverTimestamp() 
                });
                UI.toast('Enviado', 'success');
            } catch(e) { UI.toast('Error subida', 'error'); }
            input.value = '';
        };

        // EVENT BINDINGS FOR SAVING
        document.getElementById('saveTaskBtn').onclick = async () => {
            const id = document.getElementById('taskId').value;
            const text = document.getElementById('taskInput').value.trim();
            const assignee = document.getElementById('taskAssignee').value.trim();
            const priority = document.getElementById('taskPriority').value;
            const cycle = document.getElementById('taskCycle').value;
            
            if(!text) return UI.toast('Falta descripción', 'error');
            UI.closeModal();

            const data = { text, assignee, priority, cycle, branch: State.branch, updatedAt: serverTimestamp() };
            
            try {
                if(id) {
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'tasks', id), data);
                    UI.toast('Tarea actualizada', 'success');
                } else {
                    data.status = 'pending';
                    data.createdAt = serverTimestamp();
                    await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'tasks'), data);
                    UI.toast('Tarea creada', 'success');
                }
            } catch(e) { console.error(e); UI.toast('Error', 'error'); }
        };

        document.getElementById('saveOrderBtn').onclick = async () => {
             const item = document.getElementById('orderItem').value;
             if(!item) return;
             UI.closeModal();
             await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'orders'), {
                 item,
                 amount: document.getElementById('orderAmount').value,
                 requester: document.getElementById('orderRequester').value,
                 notes: document.getElementById('orderNotes').value,
                 branch: State.branch === 'centro' ? 'Centro' : 'Ejemplares',
                 status: 'pending',
                 createdAt: serverTimestamp()
             });
             document.getElementById('orderItem').value = '';
             UI.toast('Pedido enviado', 'success');
        };

        document.getElementById('saveDelBtn').onclick = async () => {
            const client = document.getElementById('delClient').value;
            if(!client) return;
            UI.closeModal();
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'deliveries'), {
                client,
                phone: document.getElementById('delPhone').value,
                items: document.getElementById('delItems').value,
                when: document.getElementById('delWhen').value,
                where: document.getElementById('delWhere').value,
                status: 'pending',
                branchOrigin: State.branch,
                createdAt: serverTimestamp()
            });
            document.getElementById('delClient').value = '';
            UI.toast('Reparto agendado', 'success');
        };

        document.getElementById('saveNoteBtn').onclick = async () => {
            const content = document.getElementById('noteContent').value.trim();
            if(!content) return;
            UI.closeModal();
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'notes'), {
                content,
                type: document.getElementById('noteType').value,
                branch: State.branch,
                createdAt: serverTimestamp()
            });
            document.getElementById('noteContent').value = '';
        };

        document.getElementById('saveProcBtn').onclick = async () => {
            const title = document.getElementById('procTitle').value;
            const steps = document.getElementById('procSteps').value;
            if(!title) return;
            UI.closeModal();
            const color = document.querySelector('input[name="procColor"]:checked').value;
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'procedures'), { title, steps, color, createdAt: serverTimestamp() });
            document.getElementById('procTitle').value = '';
            document.getElementById('procSteps').value = '';
        };

        document.getElementById('sendChatBtn').onclick = async () => {
            const input = document.getElementById('chatTextInput');
            const text = input.value.trim();
            if(!text) return;
            input.value = '';
            await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'chat'), { 
                type: 'text', text, sender: State.user.uid, 
                branch: State.branch,
                createdAt: serverTimestamp() 
            });
        };

        // INIT
        onAuthStateChanged(auth, async (user) => {
            const ind = document.getElementById('connectionStatus');
            const loading = document.getElementById('loadingIndicator');
            
            if (user) {
                State.user = user;
                ind.innerText = "Conectado · " + user.uid.slice(0,4);
                loading.classList.remove('hidden');
                Data.resubscribe();
                // Fake loading delay removal
                setTimeout(() => loading.classList.add('hidden'), 1000);
            } else {
                ind.innerText = "Desconectado";
                 if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            }
        });

        UI.init();
    </script>
</body>
</html>
