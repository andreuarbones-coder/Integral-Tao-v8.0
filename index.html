<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jard√≠n OS</title>
    
    <!-- PWA Manifest (Inline Base64) -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkphcmTDrW4gT1MiLAogICJzaG9ydF9uYW1lIjogIkphcmTDrW4iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzFmMjkzNyIsCiAgInRoZW1lX2NvbG9yIjogIiMxMTE4MjciLAogICJpY29ucyI6IFt7CiAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzE1MTgvMTUxODE1NS5wbmciLAogICAgInNpemVzIjogIjUxMng1MTIiLAogICAgInR5cGUiOiAiaW1hZ2UvcG5nIgogIH1dCn0=">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kalam:wght@300;400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, updateDoc, doc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- CONFIGURATION & INIT ---
        const manualConfig = { apiKey: "" }; // API Key injected by environment
        let firebaseConfig = manualConfig;
        
        // Dynamic Config Loading
        try {
            if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);
        } catch(e) { console.error("Config Error", e); }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'jardin-os-default';

        // --- GLOBAL STATE & UTILS ---
        const state = {
            user: null,
            branch: localStorage.getItem('jardin_branch') || 'centro', // Default branch
            currentTab: 'tasks',
            audioStream: null,
            mediaRecorder: null,
            audioChunks: [],
            isRecording: false
        };

        const DOM = {
            app: document.getElementById('app-root'),
            toastContainer: document.getElementById('toast-container'),
            views: document.querySelectorAll('.view-section'),
            navBtns: document.querySelectorAll('.nav-btn'),
            branchLabel: document.getElementById('branch-label'),
            branchModal: document.getElementById('branch-modal'),
            repartosBadge: document.getElementById('repartos-badge')
        };

        // Utility: Toast Notification
        window.showToast = (msg, type = 'info') => {
            const toast = document.createElement('div');
            const colors = type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-gray-800');
            toast.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg mb-2 transform transition-all duration-300 translate-y-10 opacity-0 flex items-center gap-2 z-50`;
            toast.innerHTML = `<span>${msg}</span>`;
            DOM.toastContainer.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        // Utility: Path Generators
        const getBranchPath = (col) => `artifacts/${appId}/branches/${state.branch}/${col}`;
        const getGlobalPath = (col) => `artifacts/${appId}/${col}_globales`;

        // --- AUTHENTICATION ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth failed", error);
                showToast("Error de autenticaci√≥n", "error");
            }
        };

        // --- MODULES ---

        // 1. TASKS MODULE
        const initTasks = () => {
            const listEl = document.getElementById('tasks-list');
            const q = query(collection(db, getBranchPath('tasks')), orderBy('createdAt', 'desc'));
            
            onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    listEl.innerHTML = `<div class="text-center text-gray-400 mt-10"><i class="fas fa-clipboard-check text-4xl mb-2"></i><p>Todo limpio por hoy</p></div>`;
                    return;
                }
                
                snapshot.forEach(docSnap => {
                    const task = docSnap.data();
                    const priorityColors = {
                        'urgente': 'border-l-4 border-red-500 bg-red-50',
                        'alta': 'border-l-4 border-orange-400 bg-orange-50',
                        'media': 'border-l-4 border-blue-400 bg-blue-50',
                        'baja': 'border-l-4 border-gray-300 bg-white'
                    };
                    
                    const div = document.createElement('div');
                    div.className = `p-3 rounded shadow-sm mb-3 flex items-start gap-3 bg-white ${priorityColors[task.priority] || 'bg-white'}`;
                    div.innerHTML = `
                        <input type="checkbox" class="mt-1.5 w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500 task-check" 
                            data-id="${docSnap.id}" data-cyclic="${task.isCyclic}" ${task.completed ? 'checked' : ''}>
                        <div class="flex-grow">
                            <p class="${task.completed ? 'line-through text-gray-400' : 'text-gray-800 font-medium'}">${task.text}</p>
                            <div class="flex gap-2 text-xs text-gray-500 mt-1">
                                ${task.isCyclic ? '<span class="text-purple-600 font-bold"><i class="fas fa-sync-alt"></i> C√≠clica</span>' : ''}
                                <span>${task.priority.toUpperCase()}</span>
                            </div>
                        </div>
                        <button class="text-gray-400 hover:text-red-500 task-delete" data-id="${docSnap.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    listEl.appendChild(div);
                });

                // Event Delegation
                listEl.querySelectorAll('.task-check').forEach(cb => {
                    cb.addEventListener('change', async (e) => {
                        const id = e.target.dataset.id;
                        const cyclic = e.target.dataset.cyclic === 'true';
                        // Cyclic tasks uncheck themselves next day logically, but for UI we just don't delete them.
                        // Standard delete/complete logic:
                        if (!cyclic && e.target.checked) {
                            // If not cyclic, standard complete behavior (optional delay to delete or just keep checked)
                             await updateDoc(doc(db, getBranchPath('tasks'), id), { completed: e.target.checked });
                        } else {
                             await updateDoc(doc(db, getBranchPath('tasks'), id), { completed: e.target.checked });
                        }
                    });
                });
                
                listEl.querySelectorAll('.task-delete').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        if(confirm('¬øBorrar tarea?')) {
                            await deleteDoc(doc(db, getBranchPath('tasks'), e.currentTarget.dataset.id));
                        }
                    });
                });
            });

            document.getElementById('task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = document.getElementById('task-input').value;
                const priority = document.getElementById('task-priority').value;
                const isCyclic = document.getElementById('task-cyclic').checked;
                
                if(!text.trim()) return;

                try {
                    await addDoc(collection(db, getBranchPath('tasks')), {
                        text, priority, isCyclic, completed: false, createdAt: serverTimestamp()
                    });
                    e.target.reset();
                    showToast("Tarea a√±adida", "success");
                } catch(err) { showToast("Error al guardar", "error"); }
            });
        };

        // 2. DELIVERIES MODULE (Repartos)
        const initRepartos = () => {
            const listEl = document.getElementById('repartos-list');
            // Global collection
            const q = query(collection(db, getGlobalPath('repartos')), orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                // Badge Update
                const count = snapshot.docs.length;
                DOM.repartosBadge.textContent = count > 0 ? count : '';
                DOM.repartosBadge.style.display = count > 0 ? 'flex' : 'none';

                listEl.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const r = docSnap.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-4 rounded-lg shadow-sm border-l-4 border-indigo-500 mb-3";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-800">${r.client}</h3>
                            <span class="bg-indigo-100 text-indigo-800 text-xs px-2 py-1 rounded-full">${r.when}</span>
                        </div>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p><i class="fas fa-box-open w-5"></i> ${r.order}</p>
                            <p><i class="fas fa-map-marker-alt w-5"></i> ${r.address}</p>
                            <p><i class="fas fa-phone w-5"></i> <a href="tel:${r.phone}" class="text-blue-500 underline">${r.phone}</a></p>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button class="text-green-600 hover:text-green-800 text-sm font-medium complete-reparto" data-id="${docSnap.id}">
                                <i class="fas fa-check-circle mr-1"></i> Completar
                            </button>
                        </div>
                    `;
                    listEl.appendChild(div);
                });

                listEl.querySelectorAll('.complete-reparto').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                         if(confirm('¬øPedido entregado?')) {
                            await deleteDoc(doc(db, getGlobalPath('repartos'), e.currentTarget.dataset.id));
                            showToast("Reparto completado", "success");
                         }
                    });
                });
            });

            // Modal Logic
            const modal = document.getElementById('reparto-modal');
            document.getElementById('add-reparto-btn').onclick = () => modal.classList.remove('hidden');
            document.getElementById('cancel-reparto').onclick = () => modal.classList.add('hidden');

            document.getElementById('reparto-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    client: document.getElementById('r-client').value,
                    phone: document.getElementById('r-phone').value,
                    order: document.getElementById('r-order').value,
                    address: document.getElementById('r-address').value,
                    when: document.getElementById('r-when').value,
                    createdAt: serverTimestamp()
                };
                
                try {
                    await addDoc(collection(db, getGlobalPath('repartos')), formData);
                    modal.classList.add('hidden');
                    e.target.reset();
                    showToast("Reparto agendado", "success");
                } catch(err) { showToast("Error al guardar", "error"); }
            });
        };

        // 3. NOTES MODULE
        const initNotes = () => {
            const container = document.getElementById('notes-container');
            const q = query(collection(db, getBranchPath('notes')), orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const note = docSnap.data();
                    const isCobro = note.type === 'cobro';
                    const div = document.createElement('div');
                    // Random rotation for post-it effect
                    const rot = Math.random() * 4 - 2; 
                    div.className = `p-4 shadow-md transition-transform hover:scale-105 relative h-48 flex flex-col`;
                    div.style.backgroundColor = isCobro ? '#fecaca' : '#fef08a'; // Red for Cobro, Yellow for Comm
                    div.style.transform = `rotate(${rot}deg)`;
                    div.style.fontFamily = '"Kalam", cursive';
                    
                    div.innerHTML = `
                        <div class="absolute -top-2 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-gray-200/50 rounded-full blur-sm"></div>
                        <div class="absolute top-1 left-1/2 transform -translate-x-1/2 w-3 h-3 bg-red-800 rounded-full shadow-sm z-10"></div>
                        <h4 class="font-bold border-b border-black/10 pb-1 mb-2 ${isCobro ? 'text-red-900' : 'text-yellow-900'}">
                            ${isCobro ? 'üí∞ COLA DE COBRO' : 'üì¢ COMUNICACI√ìN'}
                        </h4>
                        <p class="text-lg leading-snug overflow-y-auto flex-grow">${note.text}</p>
                        <button class="absolute bottom-2 right-2 text-black/40 hover:text-black delete-note" data-id="${docSnap.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });

                container.querySelectorAll('.delete-note').forEach(btn => {
                    btn.addEventListener('click', async(e) => deleteDoc(doc(db, getBranchPath('notes'), e.currentTarget.dataset.id)));
                });
            });

            document.getElementById('add-note-btn').onclick = async () => {
                const text = prompt("Escribe tu nota:");
                if(!text) return;
                const type = confirm("¬øEs para Cola de Cobro? (Cancelar = Comunicaci√≥n)") ? 'cobro' : 'comm';
                await addDoc(collection(db, getBranchPath('notes')), { text, type, createdAt: serverTimestamp() });
            };
        };

        // 4. PROCEDURES MODULE
        const initProcedures = () => {
            const listEl = document.getElementById('procedures-list');
            const q = query(collection(db, getGlobalPath('procedimientos')), orderBy('title'));

            onSnapshot(q, (snapshot) => {
                listEl.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const proc = docSnap.data();
                    const div = document.createElement('div');
                    div.className = "bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden";
                    // Parse steps split by new lines
                    const stepsHtml = (proc.steps || '').split('\n').map(s => `<li class="ml-4 list-disc text-gray-600">${s}</li>`).join('');
                    
                    div.innerHTML = `
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <h3 class="font-bold text-gray-800">${proc.title}</h3>
                            <span class="w-3 h-3 rounded-full" style="background-color: ${proc.color || '#3b82f6'}"></span>
                        </div>
                        <div class="p-4">
                            <ul class="space-y-1 text-sm">
                                ${stepsHtml}
                            </ul>
                        </div>
                    `;
                    listEl.appendChild(div);
                });
            });
            // Manual entry for procedures isn't in UI requirements, usually static or admin only. 
            // Added hidden button in footer for simple testing? No, keep it clean.
        };

        // 5. CHAT / RADIO MODULE
        const initChat = () => {
            const chatBox = document.getElementById('chat-box');
            const q = query(collection(db, getBranchPath('chat')), orderBy('createdAt', 'desc'), limit(50));
            const micBtn = document.getElementById('mic-btn');
            const sendBtn = document.getElementById('send-msg-btn');
            const msgInput = document.getElementById('msg-input');
            const imgInput = document.getElementById('img-input');

            // Render
            onSnapshot(q, (snapshot) => {
                chatBox.innerHTML = '';
                // Reverse to show bottom-up
                const messages = [];
                snapshot.forEach(d => messages.push({...d.data(), id: d.id}));
                
                messages.reverse().forEach(msg => {
                    const isMe = msg.userId === (auth.currentUser?.uid || 'anon');
                    const div = document.createElement('div');
                    div.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
                    
                    let content = '';
                    if (msg.type === 'text') content = `<p>${msg.content}</p>`;
                    if (msg.type === 'image') content = `<img src="${msg.content}" class="rounded-lg max-w-[200px] border border-gray-200" loading="lazy" />`;
                    if (msg.type === 'audio') content = `<audio controls src="${msg.content}" class="max-w-[200px] h-10"></audio>`;

                    div.innerHTML = `
                        <div class="max-w-[75%] ${isMe ? 'bg-blue-600 text-white rounded-l-2xl rounded-tr-2xl' : 'bg-gray-100 text-gray-800 rounded-r-2xl rounded-tl-2xl'} p-3 shadow-sm text-sm">
                            ${content}
                            <div class="text-[10px] opacity-70 mt-1 text-right">${msg.createdAt?.toDate ? msg.createdAt.toDate().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '...'}</div>
                        </div>
                    `;
                    chatBox.appendChild(div);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            // Send Text
            const sendMessage = async () => {
                const txt = msgInput.value.trim();
                if(!txt) return;
                await addDoc(collection(db, getBranchPath('chat')), {
                    type: 'text', content: txt, userId: auth.currentUser?.uid, createdAt: serverTimestamp()
                });
                msgInput.value = '';
            };
            sendBtn.onclick = sendMessage;
            msgInput.addEventListener('keypress', (e) => e.key === 'Enter' && sendMessage());

            // Image
            document.getElementById('img-btn').onclick = () => imgInput.click();
            imgInput.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                
                showToast("Subiendo imagen...", "info");
                try {
                    const storageRef = ref(storage, `chat/${Date.now()}_${file.name}`);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    await addDoc(collection(db, getBranchPath('chat')), {
                        type: 'image', content: url, userId: auth.currentUser?.uid, createdAt: serverTimestamp()
                    });
                    e.target.value = ''; // Clear
                } catch(err) { showToast("Error al subir", "error"); }
            };

            // PTT Logic
            const handleStartRecording = async (e) => {
                e.preventDefault();
                micBtn.classList.add('bg-red-600', 'scale-110');
                state.audioChunks = [];
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    state.audioStream = stream;
                    state.mediaRecorder = new MediaRecorder(stream);
                    state.mediaRecorder.ondataavailable = event => state.audioChunks.push(event.data);
                    state.mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(state.audioChunks, { type: 'audio/mp4' }); // mp4/webm often better for mobile
                        // Upload
                        const storageRef = ref(storage, `audio/${Date.now()}.mp4`);
                        await uploadBytes(storageRef, audioBlob);
                        const url = await getDownloadURL(storageRef);
                        await addDoc(collection(db, getBranchPath('chat')), {
                            type: 'audio', content: url, userId: auth.currentUser?.uid, createdAt: serverTimestamp()
                        });
                    };
                    state.mediaRecorder.start();
                    state.isRecording = true;
                    showToast("Grabando...", "info");
                } catch(err) {
                    console.error(err);
                    showToast("Permiso de micr√≥fono denegado", "error");
                    micBtn.classList.remove('bg-red-600', 'scale-110');
                }
            };

            const handleStopRecording = (e) => {
                if(!state.isRecording) return;
                e.preventDefault();
                micBtn.classList.remove('bg-red-600', 'scale-110');
                if(state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
                    state.mediaRecorder.stop();
                    state.audioStream.getTracks().forEach(track => track.stop());
                }
                state.isRecording = false;
            };

            // Touch & Mouse events for PTT
            micBtn.addEventListener('mousedown', handleStartRecording);
            micBtn.addEventListener('mouseup', handleStopRecording);
            micBtn.addEventListener('mouseleave', handleStopRecording);
            micBtn.addEventListener('touchstart', handleStartRecording, {passive: false});
            micBtn.addEventListener('touchend', handleStopRecording);
        };

        // --- NAVIGATION & SWIPE ---
        const switchTab = (tabId) => {
            // Update UI
            DOM.views.forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${tabId}`).classList.remove('hidden');
            
            DOM.navBtns.forEach(btn => {
                const isActive = btn.dataset.tab === tabId;
                btn.classList.toggle('text-blue-600', isActive);
                btn.classList.toggle('text-gray-400', !isActive);
            });
            state.currentTab = tabId;
            // Scroll top
            document.querySelector('main').scrollTo(0,0);
        };

        const initNavigation = () => {
            DOM.navBtns.forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            // Swipe Logic
            let touchStartX = 0;
            let touchEndX = 0;
            const contentArea = document.querySelector('main');
            
            contentArea.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX, {passive: true});
            contentArea.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
            }, {passive: true});

            const tabs = ['tasks', 'repartos', 'notes', 'procedimientos', 'chat'];
            
            const handleSwipe = () => {
                const threshold = 100; // px
                const diff = touchStartX - touchEndX;
                
                if (Math.abs(diff) < threshold) return;

                const currentIndex = tabs.indexOf(state.currentTab);
                if (diff > 0 && currentIndex < tabs.length - 1) {
                    // Swipe Left -> Next Tab
                    switchTab(tabs[currentIndex + 1]);
                } else if (diff < 0 && currentIndex > 0) {
                    // Swipe Right -> Prev Tab
                    switchTab(tabs[currentIndex - 1]);
                }
            };
        };

        // --- BRANCH MANAGEMENT ---
        const initBranch = () => {
            // UI Set
            DOM.branchLabel.textContent = state.branch.toUpperCase();
            
            // Switcher
            document.getElementById('branch-selector-btn').onclick = () => DOM.branchModal.classList.remove('hidden');
            document.querySelectorAll('.select-branch-btn').forEach(btn => {
                btn.onclick = () => {
                    const newBranch = btn.dataset.branch;
                    localStorage.setItem('jardin_branch', newBranch);
                    location.reload(); // Hard reload to clear listeners ensures clean state
                };
            });
            document.getElementById('close-branch-modal').onclick = () => DOM.branchModal.classList.add('hidden');
        };

        // --- MAIN ENTRY POINT ---
        window.addEventListener('load', async () => {
            initBranch();
            await initAuth();
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user = user;
                    console.log("User:", user.uid);
                    // Init Modules
                    initTasks();
                    initRepartos();
                    initNotes();
                    initProcedures();
                    initChat();
                    initNavigation();
                    
                    // Show default
                    switchTab('tasks');
                }
            });
        });

    </script>
    <style>
        /* Custom Scrollbar for desktop niceness */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Disable standard select on specific UI elements */
        .no-select { user-select: none; -webkit-user-select: none; }
        
        /* Font Family */
        body { font-family: 'Inter', sans-serif; }
        
        /* Mobile Safe Area fixes */
        main { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 fixed inset-0 flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white shadow-sm z-20 flex-none h-14 flex items-center justify-between px-4">
        <div class="flex items-center gap-2" id="branch-selector-btn">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-sm">
                JS
            </div>
            <div class="leading-tight">
                <h1 class="font-bold text-gray-900 text-sm">Jard√≠n OS</h1>
                <p id="branch-label" class="text-[10px] text-gray-500 font-semibold tracking-wider">CARGANDO...</p>
            </div>
            <i class="fas fa-chevron-down text-xs text-gray-400 ml-1"></i>
        </div>
        <div>
            <!-- Generic User Icon or Status -->
            <div class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-400">
                <i class="fas fa-user"></i>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT AREA (Scrollable) -->
    <main class="flex-grow overflow-y-auto relative bg-gray-50">
        
        <!-- 1. TASKS VIEW -->
        <section id="view-tasks" class="view-section p-4 pb-20">
            <form id="task-form" class="bg-white p-3 rounded-lg shadow-sm mb-4 border border-gray-100">
                <div class="flex gap-2 mb-2">
                    <input type="text" id="task-input" placeholder="Nueva tarea..." class="flex-grow bg-gray-50 border-0 rounded px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    <select id="task-priority" class="bg-gray-50 text-sm rounded px-2 outline-none">
                        <option value="urgente">Urgente</option>
                        <option value="alta">Alta</option>
                        <option value="media" selected>Media</option>
                        <option value="baja">Baja</option>
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <label class="flex items-center gap-2 text-xs text-gray-600">
                        <input type="checkbox" id="task-cyclic" class="text-blue-600 rounded">
                        <span>Es Tarea C√≠clica</span>
                    </label>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-1.5 rounded text-sm font-medium hover:bg-blue-700">Agregar</button>
                </div>
            </form>
            <div id="tasks-list">
                <!-- Tasks injected here -->
                <div class="flex justify-center mt-10"><i class="fas fa-circle-notch fa-spin text-gray-300 text-2xl"></i></div>
            </div>
        </section>

        <!-- 2. REPARTOS VIEW -->
        <section id="view-repartos" class="view-section hidden p-4 pb-20">
            <button id="add-reparto-btn" class="w-full bg-indigo-600 text-white py-3 rounded-lg shadow-md font-medium mb-4 flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i> Nuevo Reparto
            </button>
            <div id="repartos-list">
                <!-- Repartos injected here -->
            </div>
        </section>

        <!-- 3. NOTES VIEW -->
        <section id="view-notes" class="view-section hidden p-4 pb-20">
            <button id="add-note-btn" class="w-full border-2 border-dashed border-gray-300 text-gray-400 py-3 rounded-lg font-medium mb-6 hover:border-gray-400 hover:text-gray-500 transition-colors">
                <i class="fas fa-plus mr-1"></i> Agregar Nota Adhesiva
            </button>
            <div id="notes-container" class="grid grid-cols-2 gap-4">
                <!-- Notes injected here -->
            </div>
        </section>

        <!-- 4. PROCEDURES VIEW -->
        <section id="view-procedimientos" class="view-section hidden p-4 pb-20">
            <div class="mb-4">
                <h2 class="text-lg font-bold text-gray-800">Base de Conocimiento</h2>
                <p class="text-sm text-gray-500">Procedimientos estandarizados</p>
            </div>
            <div id="procedures-list" class="space-y-4">
                <!-- Procedures injected here -->
            </div>
        </section>

        <!-- 5. CHAT VIEW -->
        <section id="view-chat" class="view-section hidden flex flex-col h-full">
            <div id="chat-box" class="flex-grow overflow-y-auto p-4 space-y-3 pb-24">
                <!-- Chat messages -->
            </div>
            
            <!-- Chat Input Area (Sticky Bottom) -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-3 py-2 flex items-center gap-2 z-30">
                <button id="img-btn" class="text-gray-400 hover:text-blue-600 p-2"><i class="fas fa-image text-lg"></i></button>
                <input type="file" id="img-input" accept="image/*" class="hidden">
                
                <input type="text" id="msg-input" placeholder="Mensaje..." class="flex-grow bg-gray-100 border-0 rounded-full px-4 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                
                <!-- PTT Button -->
                <button id="mic-btn" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg transition-all duration-150 no-select" oncontextmenu="return false;">
                    <i class="fas fa-microphone"></i>
                </button>
                
                <!-- Send Button (Hidden by default, shown if text typed logic could be added, but simple send btn is safer) -->
                <button id="send-msg-btn" class="hidden text-blue-600 font-bold px-2">Enviar</button>
            </div>
        </section>

    </main>

    <!-- BOTTOM NAVIGATION -->
    <nav class="flex-none bg-white border-t border-gray-200 h-16 flex justify-around items-center z-20 pb-safe">
        <button class="nav-btn flex flex-col items-center gap-1 p-2 text-blue-600" data-tab="tasks">
            <i class="fas fa-tasks text-xl"></i>
            <span class="text-[10px] font-medium">Tareas</span>
        </button>
        <button class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400 relative" data-tab="repartos">
            <div id="repartos-badge" class="hidden absolute top-1 right-2 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center font-bold">0</div>
            <i class="fas fa-truck text-xl"></i>
            <span class="text-[10px] font-medium">Repartos</span>
        </button>
        <button class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400" data-tab="notes">
            <i class="fas fa-sticky-note text-xl"></i>
            <span class="text-[10px] font-medium">Notas</span>
        </button>
        <button class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400" data-tab="procedimientos">
            <i class="fas fa-book text-xl"></i>
            <span class="text-[10px] font-medium">Gu√≠a</span>
        </button>
        <button class="nav-btn flex flex-col items-center gap-1 p-2 text-gray-400" data-tab="chat">
            <i class="fas fa-comments text-xl"></i>
            <span class="text-[10px] font-medium">Radio</span>
        </button>
    </nav>

    <!-- MODALS -->
    
    <!-- Reparto Modal -->
    <div id="reparto-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl animate-[fadeIn_0.2s_ease-out]">
            <h3 class="text-xl font-bold mb-4">Nuevo Reparto</h3>
            <form id="reparto-form" class="space-y-3">
                <input id="r-client" type="text" placeholder="Cliente" class="w-full bg-gray-50 border rounded p-2 text-sm" required>
                <input id="r-phone" type="tel" placeholder="Tel√©fono" class="w-full bg-gray-50 border rounded p-2 text-sm" required>
                <textarea id="r-order" placeholder="Detalle del pedido" class="w-full bg-gray-50 border rounded p-2 text-sm" rows="2" required></textarea>
                <input id="r-address" type="text" placeholder="Direcci√≥n / Ubicaci√≥n" class="w-full bg-gray-50 border rounded p-2 text-sm" required>
                <input id="r-when" type="text" placeholder="Cu√°ndo (ej: Hoy 14hs)" class="w-full bg-gray-50 border rounded p-2 text-sm" required>
                
                <div class="flex gap-3 mt-4">
                    <button type="button" id="cancel-reparto" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded font-medium">Cancelar</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 rounded font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Branch Modal -->
    <div id="branch-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-6">Selecciona Sucursal</h3>
            <div class="grid gap-3">
                <button class="select-branch-btn bg-blue-50 text-blue-700 py-3 rounded-lg font-bold border border-blue-200 hover:bg-blue-100" data-branch="centro">
                    üè¢ CENTRO
                </button>
                <button class="select-branch-btn bg-green-50 text-green-700 py-3 rounded-lg font-bold border border-green-200 hover:bg-green-100" data-branch="ejemplares">
                    üå≤ EJEMPLARES
                </button>
            </div>
            <button id="close-branch-modal" class="mt-6 text-sm text-gray-500 underline">Cerrar</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 left-0 right-0 flex flex-col items-center pointer-events-none px-4"></div>

</body>
</html>
